<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicesumar Studeo Login</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="successMessage" role="alert" aria-live="assertive">
        Login efetuado! Redirecionando...
    </div>
    <div class="switch-container" id="switchContainer">

        <div class="auth-step" id="loginStep">

            <div class="logo-container">
                <img src="https://static.poder360.com.br/2024/06/LOGOS-ASSINATURA-NEGATIVO-1.png" alt="Logo Assinatura"
                    class="logo-signature">
            </div>
            <h1>Entrar</h1>
            <p class="subtitle">Use a sua conta.</p>

            <div class="input-container">
                <input type="text" id="username" placeholder=" " autocomplete="username">
                <label for="username" class="input-label">Email (nome.sobrenome)</label>
            </div>
            <p id="loginEmailError" class="error-message"></p>
            <button id="loginEmailNextBtn">Avançar</button>
        </div>

        <div class="auth-step" id="loginPassStep">
            <div class="logo-container">
                <img src="https://static.poder360.com.br/2024/06/LOGOS-ASSINATURA-NEGATIVO-1.png" alt="Logo Assinatura"
                    class="logo-signature">
            </div>
            <h1 class="form-heading">Bem-vindo de volta!</h1>
            <p class="form-subheading" id="userEmailDisplay">Entre com a sua senha.</p>
            <div class="input-container">
                <input type="password" id="loginPassword" placeholder=" " autocomplete="current-password">
                <label for="loginPassword" class="input-label">Senha</label>
                <button type="button" class="password-toggle-btn" aria-label="Mostrar ou esconder senha"
                    data-input-id="loginPassword">
                    <svg class="eye-open" style="display: block;" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24">
                        <path
                            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                    </svg>
                    <svg class="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24">
                        <path
                            d="M12 6.5c3.22 0 6.13 1.62 8 4.37-1.87 2.75-4.78 4.37-8 4.37S5.87 13.62 4 10.87C5.87 8.12 8.78 6.5 12 6.5M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zm0 13a5 5 0 110-10 5 5 0 010 10zM12 10.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" />
                    </svg>
                </button>
            </div>
            <p id="loginError" class="error-message">Senha incorreta. Tente novamente.</p>
            <button id="loginSubmitBtn">Entrar</button>
            <p class="modal-footer-link">
                <a href="#" id="backToLoginEmail">Voltar</a>
            </p>
        </div>
    </div>

    <footer class="page-footer">
        <div class="footer-links">
            <a href="#">Ajuda e comentários</a>
            <a href="#">Termos de uso</a>
            <a href="#">Política de privacidade</a>
        </div>
        <span class="privacy-text">
            © 2025 Secretaria Acadêmica Unicesumar | Desenvolvimento e Qualidade | João Vitor Silvério <a
                href="#">Saiba mais</a>
        </span>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('switchContainer');
            const successMessage = document.getElementById('successMessage');

            // URL do Google Apps Script
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwAzWvxV_6F8EqtmY8XCB6WN_yhGY4V2g4-jFZ52d_T8pZpjHfKARUaNVld2GM03OKivw/exec";

            // Elementos de Navegação e Login
            const backToLoginEmailLink = document.getElementById('backToLoginEmail');

            const loginUsernameInput = document.getElementById('username');
            const loginNextBtn = document.getElementById('loginEmailNextBtn');
            const loginEmailError = document.getElementById('loginEmailError');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            const loginPasswordErrorMsg = document.getElementById('loginError');
            let currentLoginEmail = ''; // Armazena o email validado

            // --- Funções de Navegação de Passo ---

            const hideAllErrors = () => {
                [loginEmailError, loginPasswordErrorMsg]
                    .forEach(el => el && el.classList.remove('visible'));
            };

            const clearAllInputs = () => {
                [loginUsernameInput, loginPasswordInput]
                    .forEach(input => input && (input.value = ''));
            };

            const showLogin = (e) => {
                if (e) e.preventDefault();
                container.className = 'switch-container'; // Volta ao estado inicial (loginStep)
                hideAllErrors();
                clearAllInputs();
            };

            const showLoginPassword = (email) => {
                container.className = 'switch-container show-login-password';
                currentLoginEmail = email;
                if (userEmailDisplay) {
                    userEmailDisplay.textContent = `Entre com a sua senha para ${email}`;
                }
                loginPasswordInput.value = '';
                hideAllErrors();
            };

            // Associa evento de volta
            if (backToLoginEmailLink) backToLoginEmailLink.addEventListener('click', showLogin);


            // --- Lógica de Validação e Envio (Login/Email) - MODIFICADO PARA USAR O APPS SCRIPT ---

            if (loginNextBtn) {
                loginNextBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (loginEmailError) loginEmailError.classList.remove('visible');

                    const usernameValue = loginUsernameInput.value.trim().toLowerCase();
                    const isValidFormat = /\S+@\S+\.\S+/.test(usernameValue);
                    let errorText = '';

                    if (!usernameValue) {
                        errorText = "Por favor, insira seu email ou número de telefone.";
                    } else if (!isValidFormat) {
                        errorText = "O formato do email inserido é inválido.";
                    }

                    if (errorText) {
                        if (loginEmailError) {
                            loginEmailError.textContent = errorText;
                            loginEmailError.classList.add('visible');
                        }
                        return;
                    }
                    
                    // Inicia o processo de verificação no Apps Script
                    loginNextBtn.disabled = true;
                    loginNextBtn.textContent = "Verificando...";

                    try {
                        // Faz a requisição GET para o Apps Script com o email como parâmetro
                        const url = `${SCRIPT_URL}?email=${encodeURIComponent(usernameValue)}&action=checkEmail`;
                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error(`Erro de rede ou Apps Script. Status: ${response.status}`);
                        }
                        
                        const result = await response.json();

                        if (result.exists) {
                            console.log("E-mail encontrado. Prosseguindo para a senha.");
                            showLoginPassword(usernameValue);
                        } else {
                            errorText = "Não encontramos uma conta para este e-mail.";
                            if (loginEmailError) {
                                loginEmailError.textContent = errorText;
                                loginEmailError.classList.add('visible');
                            }
                        }
                    } catch (error) {
                        console.error('[ERRO DE REDE/FETCH - CHECK EMAIL]', error);
                        errorText = "Erro ao verificar o email. Tente novamente ou verifique o link do Apps Script.";
                        if (loginEmailError) {
                            loginEmailError.textContent = errorText;
                            loginEmailError.classList.add('visible');
                        }
                    }

                    // Restaura o botão se não avançou para a senha
                    if (!container.classList.contains('show-login-password')) {
                        loginNextBtn.disabled = false;
                        loginNextBtn.textContent = "Avançar";
                    }
                });
            }

            // --- Lógica de Validação e Envio (Login/Senha) - AJUSTADA PARA VERIFICAR A SENHA ---
            if (loginSubmitBtn) {
                loginSubmitBtn.addEventListener('click', async (e) => {
                    e.preventDefault();

                    const passwordValue = loginPasswordInput.value;
                    const email = currentLoginEmail;
                    let errorMessage = "";

                    if (passwordValue.length < 1) {
                        errorMessage = "Por favor, insira sua senha.";
                    }

                    if (errorMessage) {
                        loginPasswordErrorMsg.textContent = errorMessage;
                        loginPasswordErrorMsg.classList.add('visible');
                        return;
                    }

                    loginSubmitBtn.disabled = true;
                    loginSubmitBtn.textContent = "Verificando...";
                    loginPasswordErrorMsg.classList.remove('visible');

                    const data = {
                        action: 'login',
                        email: email,
                        senha: passwordValue
                    };

                    try {
                        // Requisição POST para o Apps Script. 
                        // Removido 'mode: no-cors' para poder ler a resposta de validação
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                // O Apps Script precisa estar configurado para aceitar este Content-Type
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams(data)
                        });

                        if (!response.ok) {
                             // Lançar erro de status HTTP, se não for sucesso (200-299)
                            throw new Error(`Erro de rede ou Apps Script. Status: ${response.status}`);
                        }
                        
                        // Espera que o Apps Script retorne um JSON (ex: { "success": true })
                        const result = await response.json();

                        if (result.success === true) {
                            console.log(`[SUCESSO DE LOGIN] Login validado pelo script.`);
                            
                            // Ação de SUCESSO DE LOGIN: Exibir mensagem e redirecionar
                            successMessage.textContent = "Login efetuado! Redirecionando...";
                            successMessage.classList.add('show');

                            setTimeout(() => {
                                window.location.href = "DEMANDA CSC.html"; // Redireciona para a página principal (simulado)
                            }, 2000);

                        } else {
                            // Ação de FALHA DE LOGIN (ex: senha incorreta, conforme retornado pelo Apps Script)
                            errorMessage = result.message || "Senha incorreta. Tente novamente.";
                            loginPasswordErrorMsg.textContent = errorMessage;
                            loginPasswordErrorMsg.classList.add('visible');
                            loginSubmitBtn.disabled = false;
                            loginSubmitBtn.textContent = "Entrar";
                        }

                    } catch (error) {
                        console.error('[ERRO DE REDE/FETCH - LOGIN]', error);
                        loginPasswordErrorMsg.textContent = "Erro ao conectar. Tente novamente.";
                        loginPasswordErrorMsg.classList.add('visible');
                        loginSubmitBtn.disabled = false;
                        loginSubmitBtn.textContent = "Entrar";
                    }
                });
            }

            // --- Lógica de Alternância de Visibilidade da Senha ---
            document.querySelectorAll('.password-toggle-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.getAttribute('data-input-id');
                    const input = document.getElementById(inputId);
                    const eyeOpen = button.querySelector('.eye-open');
                    const eyeClosed = button.querySelector('.eye-closed');

                    if (input.type === 'password') {
                        input.type = 'text';
                        eyeOpen.style.display = 'none';
                        eyeClosed.style.display = 'block';
                    } else {
                        input.type = 'password';
                        eyeOpen.style.display = 'block';
                        eyeClosed.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>

</html>